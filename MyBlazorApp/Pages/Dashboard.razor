@page "/dashboard"
@using MyBlazorApp.Models
@using MyBlazorApp.Services
@using MyBlazorApp.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms


@inject LocalStorageService LocalStorageService
@inject NavigationManager Navigation
@inject MembershipService MembershipService

<PageTitle>Dashboard</PageTitle>

@if (showMessage)
{
    <div class="overlay">
        <div class="message-box">
            @successMessage
        </div>
    </div>
}
@if (showContactMessage)
{
    <div class="update-toast">
        @contactMessage
    </div>
}



<div class="page-header">
    <div class="container">
        <h1 class="mb-0">
            <i class="bi bi-speedometer2 me-3"></i>Ãœyelik Durumu
        </h1>
        <p class="mb-0 mt-2 opacity-75">Ãœyelik bilgilerinizi ve kalan sÃ¼renizi gÃ¶rÃ¼ntÃ¼leyin</p>
    </div>
</div>

<div class="container mt-5">
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="loading-spinner mx-auto mb-3"></div>
            <p class="text-muted">Bilgiler yÃ¼kleniyor...</p>
        </div>
    }
    else if (userMembership != null)
    {
        <div class="row g-4">
            <div class="col-lg-8">
                <MembershipStatus UserMembership="userMembership"
                  OnRenew="HandleRenew"
                  OnCancel="HandleCancel" />

            </div>
<div class="col-lg-4">
    <div class="card shadow membership-card">
        <div class="card-header text-white d-flex justify-content-between align-items-center"
             style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <h5 class="mb-0">
                <i class="bi bi-person-badge me-2"></i>Ãœye Bilgileri
            </h5>

            <button class="btn btn-sm btn-light"
                    @onclick="ToggleEditContact">
                <i class="bi bi-pencil-square me-1"></i>
                @(isEditingContact ? "VazgeÃ§" : "DÃ¼zenle")
            </button>
        </div>

        <div class="card-body">

            <!-- ðŸ”µ AVATAR KISMI (YENÄ°) -->
            <div class="text-center mb-3">
                <img src="@CurrentAvatar"
                     alt="Avatar"
                     class="profile-avatar" />

                @if (isEditingContact)
                {
                    <div class="mt-2">
                        <label class="btn btn-sm btn-outline-primary">
                            Avatar SeÃ§
                            <InputFile OnChange="OnAvatarChange" accept="image/*" />
                        </label>
                    </div>
                }
            </div>

            <!-- Ad Soyad -->
            <div class="mb-3">
                <div class="stat-label mb-1">
                    <i class="bi bi-person-fill me-2 text-primary"></i>Ad Soyad
                </div>
                <div class="fw-bold">@userMembership.Member.FullName</div>
            </div>
            <hr>

            <!-- E-posta -->
            <div class="mb-3">
                <div class="stat-label mb-1">
                    <i class="bi bi-envelope-fill me-2 text-primary"></i>E-posta
                </div>

                @if (isEditingContact)
                {
                    <input class="form-control" @bind="editEmail" />
                }
                else
                {
                    <div>@userMembership.Member.Email</div>
                }
            </div>
            <hr>

            <!-- Telefon -->
            <div class="mb-3">
                <div class="stat-label mb-1">
                    <i class="bi bi-telephone-fill me-2 text-primary"></i>Telefon
                </div>

                @if (isEditingContact)
                {
                    <input class="form-control" @bind="editPhone" />
                }
                else
                {
                    <div>@userMembership.Member.Phone</div>
                }
            </div>
            <hr>

            <!-- TC Kimlik -->
            <div class="mb-0">
                <div class="stat-label mb-1">
                    <i class="bi bi-card-text me-2 text-primary"></i>TC Kimlik No
                </div>
                <div>@userMembership.Member.TcKimlikNo</div>
            </div>

            @if (isEditingContact)
            {
                <button class="btn btn-primary-custom w-100 mt-3"
                        @onclick="SaveContactChanges">
                    <i class="bi bi-check-circle me-1"></i>
                    Bilgileri Kaydet
                </button>
            }
        </div>
    </div>
</div>

        </div>
    }
    else
    {
        <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h4>Ãœyelik BulunamadÄ±</h4>
            <p class="text-muted mb-4">HenÃ¼z bir Ã¼yeliÄŸiniz bulunmamaktadÄ±r. Ãœyelik planlarÄ±nÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in aÅŸaÄŸÄ±daki butona tÄ±klayÄ±n.</p>
            <button class="btn btn-primary-custom" @onclick="NavigateToMemberships">
                <i class="bi bi-ticket-perforated me-2"></i>Ãœyelik PlanlarÄ±nÄ± GÃ¶rÃ¼ntÃ¼le
            </button>
        </div>
    }
</div>

@code {
    private UserMembership? userMembership;
    private bool isLoading = true;
    private string? successMessage;
    private bool showMessage = false;
    private bool isEditingContact = false;
    private string? editEmail;
    private string? editPhone;

    private string CurrentAvatar =>
        string.IsNullOrEmpty(userMembership?.Member.AvatarUrl)
            ? "img/default-avatar.png"
            : userMembership.Member.AvatarUrl;

    private string? contactMessage;
    private bool showContactMessage;

    private async Task ShowMessage(string message)
    {
        successMessage = message;
        showMessage = true;
        StateHasChanged();

        await Task.Delay(3000); // 3 saniye bekle
        showMessage = false;
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            userMembership = await LocalStorageService.GetMembershipAsync();

            if (userMembership is not null)
            {
                editEmail = userMembership.Member.Email;
                editPhone = userMembership.Member.Phone;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Hata: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }


    // ÃœyeliÄŸi Yenile butonuna basÄ±lÄ±nca Ã§alÄ±ÅŸacak
private async Task HandleRenew()
{
    if (userMembership is null)
        return;

    var today = DateTime.Today;

    // Plan sÃ¼resi: Ã–rn. 30, 180, 365 gÃ¼n
    var duration = userMembership.DurationDays;

    // EÄŸer DurationDays ayarlanmamÄ±ÅŸsa, mevcut Ã¼yelikten hesapla
    if (duration <= 0)
    {
        var diff = (userMembership.EndDate.Date - userMembership.StartDate.Date).Days;
        duration = diff > 0 ? diff : 30; // yine de 0 Ã§Ä±karsa 30 gÃ¼n varsay
    }

    // ðŸ”¹ Eski davranÄ±ÅŸ: eski bitiÅŸe ekliyorduk
    // var newStartDate = userMembership.EndDate.Date < today ? today : userMembership.EndDate.Date;
    // var newEndDate = newStartDate.AddDays(duration);

    // ðŸ”¹ Yeni istediÄŸin davranÄ±ÅŸ:
    //    - Her yenilemede Ã¼yelik BUGÃœN'den baÅŸlasÄ±n
    //    - Plan sÃ¼resi kadar ileri bir bitiÅŸ tarihi olsun
    userMembership.StartDate = today;
    userMembership.EndDate   = today.AddDays(duration);
    userMembership.IsActive  = true;

    // Test kodu yerine gerÃ§ek bir kod Ã¼retelim
    userMembership.MembershipCode = MembershipService.GenerateMembershipCode();

    await LocalStorageService.SaveMembershipAsync(userMembership);
    await ShowMessage("Ãœyelik baÅŸarÄ±yla yenilendi!");
}


    // ÃœyeliÄŸi Ä°ptal Et butonuna basÄ±lÄ±nca Ã§alÄ±ÅŸacak
    private async Task HandleCancel()
    {
        if (userMembership is null)
            return;

        userMembership.IsActive = false;
        userMembership.EndDate  = DateTime.Today;

        await LocalStorageService.SaveMembershipAsync(userMembership);
        await ShowMessage("Ãœyelik iptal edildi.");
        // KullanÄ±cÄ±yÄ± yeni plan seÃ§mesi iÃ§in yÃ¶nlendirebilirsin
        Navigation.NavigateTo("/memberships");
    }
        private void ToggleEditContact()
    {
        if (userMembership is null)
            return;

        // Mod deÄŸiÅŸtirirken her seferinde mevcut veriyi doldur
        if (!isEditingContact)
        {
            editEmail = userMembership.Member.Email;
            editPhone = userMembership.Member.Phone;
        }

        isEditingContact = !isEditingContact;
    }

    private void CancelEditContact()
    {
        isEditingContact = false;
        // iptalde alanlarÄ± eski hÃ¢le dÃ¶ndÃ¼r
        if (userMembership is not null)
        {
            editEmail = userMembership.Member.Email;
            editPhone = userMembership.Member.Phone;
        }
    }

    

        // Avatar dosyasÄ± Base64 olarak burada tutulacak (isteÄŸe baÄŸlÄ±)
        private string? newAvatarBase64;


        // ðŸ“Œ Avatar dosyasÄ± seÃ§ildiÄŸinde Ã§alÄ±ÅŸÄ±r
        private async Task OnAvatarChange(InputFileChangeEventArgs e)
        {
            var file = e.File;

            using var stream = file.OpenReadStream(maxAllowedSize: 4*1024 * 1024); // 1MB
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            var base64 = Convert.ToBase64String(ms.ToArray());
            newAvatarBase64 = $"data:{file.ContentType};base64,{base64}";

            // Ekrandan hemen avatarÄ± gÃ¶stermek iÃ§in
            if (userMembership is not null)
                userMembership.Member.AvatarUrl = newAvatarBase64;

            StateHasChanged();
        }


        //  E-posta, telefon VE avatar birlikte burada kaydedilir
        private async Task SaveContactChanges()
        {
            if (userMembership is null)
                return;

            // BoÅŸ bÄ±rakÄ±lmasÄ±n
            if (string.IsNullOrWhiteSpace(editEmail) ||
                string.IsNullOrWhiteSpace(editPhone))
            {
                contactMessage = "E-posta ve telefon boÅŸ bÄ±rakÄ±lamaz.";
                showContactMessage = true;
                StateHasChanged();
                await Task.Delay(3000);
                showContactMessage = false;
                StateHasChanged();
                return;
            }

            // ðŸ”¹ E-posta + Telefon gÃ¼ncelle
            userMembership.Member.Email = editEmail!;
            userMembership.Member.Phone = editPhone!;

            // ðŸ”¹ Avatar seÃ§ilmiÅŸse onu da gÃ¼ncelle
            if (!string.IsNullOrEmpty(newAvatarBase64))
            {
                userMembership.Member.AvatarUrl = newAvatarBase64;
            }

            // ðŸ”¹ TÃ¼m bilgileri kaydet
            await LocalStorageService.SaveMembershipAsync(userMembership);

            // DÃ¼zenleme modunu kapat
            isEditingContact = false;

            // ðŸ”¹ BaÅŸarÄ± mesajÄ±
            contactMessage = "Bilgileriniz baÅŸarÄ±yla gÃ¼ncellendi.";
            showContactMessage = true;

            StateHasChanged();
            await Task.Delay(3000);

            showContactMessage = false;
            StateHasChanged();
        }


        // Sayfa yÃ¶nlendirme
        private void NavigateToMemberships()
        {
            Navigation.NavigateTo("/memberships");
        }
    }}
    


